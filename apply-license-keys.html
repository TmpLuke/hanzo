<!DOCTYPE html>
<html>
<head>
    <title>Apply License Keys Migration</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: system-ui; max-width: 900px; margin: 50px auto; padding: 20px; background: #0a0a0a; color: #fff; }
        button { background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        button:hover { background: #059669; }
        .log { background: #1f2937; color: #10b981; padding: 20px; border-radius: 8px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        input { background: #1f2937; border: 1px solid #374151; color: #fff; padding: 8px 12px; border-radius: 6px; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Apply License Keys Migration</h1>
    <p>Enter your Supabase credentials to create the license keys tables.</p>
    
    <div style="margin-bottom: 20px;">
        <label>Supabase URL:</label>
        <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co" />
        
        <label>Supabase Anon Key:</label>
        <input type="password" id="supabaseKey" placeholder="Your anon key" />
    </div>
    
    <button onclick="applyMigration()">Apply Migration</button>
    <div id="log" class="log"></div>

    <script>
        function log(message, isError = false) {
            const logEl = document.getElementById('log');
            const className = isError ? 'error' : 'success';
            logEl.innerHTML += `<span class="${className}">${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        async function applyMigration() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                alert('Please enter both Supabase URL and Key');
                return;
            }
            
            document.getElementById('log').innerHTML = '';
            log('Starting migration...');
            
            const supabase = window.supabase.createClient(url, key);
            
            try {
                // Create license_keys table
                log('Creating license_keys table...');
                const { error: e1 } = await supabase.rpc('exec_sql', {
                    sql_query: `
                        CREATE TABLE IF NOT EXISTS license_keys (
                          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                          product_id TEXT NOT NULL,
                          variant_id TEXT NOT NULL,
                          license_key TEXT NOT NULL,
                          is_used BOOLEAN DEFAULT FALSE,
                          used_by_email TEXT,
                          used_at TIMESTAMP WITH TIME ZONE,
                          order_id TEXT,
                          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                    `
                });
                
                if (e1) log('Note: Table might already exist or need manual creation', true);
                else log('✓ license_keys table created');
                
                // Create product_delivery_settings table
                log('Creating product_delivery_settings table...');
                const { error: e2 } = await supabase.rpc('exec_sql', {
                    sql_query: `
                        CREATE TABLE IF NOT EXISTS product_delivery_settings (
                          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                          product_id TEXT NOT NULL,
                          variant_id TEXT NOT NULL,
                          delivery_type TEXT NOT NULL DEFAULT 'auto',
                          discord_message TEXT DEFAULT 'Please open a ticket at discord.gg/hanzo to receive your license key.',
                          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                          UNIQUE(product_id, variant_id)
                        );
                    `
                });
                
                if (e2) log('Note: Table might already exist or need manual creation', true);
                else log('✓ product_delivery_settings table created');
                
                log('\n✓ Migration completed!');
                log('You can now manage license keys in the admin dashboard.');
                log('\nIf you see errors above, please run the SQL manually in Supabase SQL Editor.');
                
            } catch (err) {
                log('Error: ' + err.message, true);
                log('\nPlease run this SQL manually in Supabase SQL Editor:', true);
                log(document.querySelector('script[type="text/sql"]').textContent);
            }
        }
    </script>
    
    <script type="text/sql">
-- Run this in Supabase SQL Editor if the automatic migration fails

-- Create license_keys table
CREATE TABLE IF NOT EXISTS license_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id TEXT NOT NULL,
  variant_id TEXT NOT NULL,
  license_key TEXT NOT NULL,
  is_used BOOLEAN DEFAULT FALSE,
  used_by_email TEXT,
  used_at TIMESTAMP WITH TIME ZONE,
  order_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create product_delivery_settings table
CREATE TABLE IF NOT EXISTS product_delivery_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id TEXT NOT NULL,
  variant_id TEXT NOT NULL,
  delivery_type TEXT NOT NULL DEFAULT 'auto',
  discord_message TEXT DEFAULT 'Please open a ticket at discord.gg/hanzo to receive your license key.',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(product_id, variant_id)
);

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_license_keys_product_variant ON license_keys(product_id, variant_id);
CREATE INDEX IF NOT EXISTS idx_license_keys_is_used ON license_keys(is_used);
CREATE INDEX IF NOT EXISTS idx_license_keys_order_id ON license_keys(order_id);
CREATE INDEX IF NOT EXISTS idx_product_delivery_settings_lookup ON product_delivery_settings(product_id, variant_id);

-- Add columns to orders table
ALTER TABLE orders ADD COLUMN IF NOT EXISTS license_key TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_type TEXT DEFAULT 'auto';
    </script>
</body>
</html>
